<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Policy Engine — Why &amp; How</title>
<style>
/* ── Reset & Base ──────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-deep: #060a14;
  --bg: #0b1120;
  --bg-card: #0f1729;
  --bg-elevated: #141e33;
  --border: #1c2942;
  --border-glow: #1e3a5f;

  --text: #e2e8f0;
  --text-dim: #8295b0;
  --text-muted: #4a5e7a;

  --cyan: #00e5ff;
  --cyan-dim: rgba(0, 229, 255, 0.15);
  --cyan-glow: rgba(0, 229, 255, 0.08);
  --teal: #2dd4a8;
  --teal-dim: rgba(45, 212, 168, 0.15);
  --amber: #ffb800;
  --amber-dim: rgba(255, 184, 0, 0.12);
  --red: #ff4757;
  --red-dim: rgba(255, 71, 87, 0.12);
  --violet: #8b5cf6;

  --mono: "SF Mono", "Cascadia Code", "Fira Code", Menlo, Consolas, monospace;
  --serif: "Iowan Old Style", "Palatino Linotype", Palatino, Georgia, serif;
  --sans: "Avenir Next", "Segoe UI", system-ui, -apple-system, sans-serif;
}

html { font-size: 18px; scroll-behavior: smooth; }

body {
  font-family: var(--sans);
  color: var(--text);
  background: var(--bg-deep);
  line-height: 1.75;
  -webkit-font-smoothing: antialiased;
  overflow-x: hidden;
  user-select: none;
  -webkit-user-select: none;
  cursor: default;
}

/* ── Dot grid background ───────────────────────────────────── */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background-image: radial-gradient(circle, rgba(255,255,255,0.03) 1px, transparent 1px);
  background-size: 32px 32px;
  pointer-events: none;
  z-index: 0;
}

/* ── Scroll progress bar ───────────────────────────────────── */
.progress-bar {
  position: fixed;
  top: 0;
  left: 0;
  height: 2px;
  background: linear-gradient(90deg, var(--cyan), var(--teal), var(--amber));
  z-index: 1000;
  width: 0%;
  transition: width 0.1s linear;
}

/* ── Step indicator ────────────────────────────────────────── */
.step-indicator {
  position: fixed;
  right: 2rem;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 100;
}
.step-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--text-muted);
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  cursor: pointer;
}
.step-dot:hover {
  background: var(--text-dim);
  transform: scale(1.3);
}
.step-dot.active {
  background: var(--cyan);
  box-shadow: 0 0 10px var(--cyan), 0 0 20px rgba(0, 229, 255, 0.3);
  transform: scale(1.4);
}

/* ── Hero ──────────────────────────────────────────────────── */
.hero {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 4rem 2rem;
  position: relative;
  z-index: 1;
}

/* Radial glow behind hero */
.hero::before {
  content: '';
  position: absolute;
  top: 20%;
  left: 50%;
  transform: translateX(-50%);
  width: 600px;
  height: 400px;
  background: radial-gradient(ellipse, rgba(0, 229, 255, 0.06) 0%, transparent 70%);
  pointer-events: none;
  z-index: -1;
}

.hero-label {
  font-family: var(--mono);
  font-size: 0.7rem;
  letter-spacing: 0.25em;
  text-transform: uppercase;
  color: var(--cyan);
  margin-bottom: 2rem;
  opacity: 0;
  animation: fadeUp 0.8s ease 0.2s forwards;
}

.hero h1 {
  font-family: var(--serif);
  font-size: 3.6rem;
  font-weight: 400;
  letter-spacing: -0.02em;
  line-height: 1.15;
  margin-bottom: 1.5rem;
  opacity: 0;
  animation: fadeUp 0.8s ease 0.4s forwards;
}

.hero h1 em {
  font-style: italic;
  background: linear-gradient(135deg, var(--cyan), var(--teal));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.hero .subtitle {
  font-size: 1.05rem;
  color: var(--text-dim);
  max-width: 480px;
  line-height: 1.8;
  opacity: 0;
  animation: fadeUp 0.8s ease 0.6s forwards;
}

.hero .scroll-hint {
  margin-top: 4rem;
  font-family: var(--mono);
  font-size: 0.7rem;
  letter-spacing: 0.15em;
  color: var(--text-muted);
  opacity: 0;
  animation: fadeUp 0.8s ease 0.8s forwards;
}
.hero .scroll-hint .arrow {
  display: block;
  margin-top: 0.75rem;
  font-size: 1.2rem;
  animation: float 2.5s ease-in-out infinite;
}

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes float {
  0%, 100% { transform: translateY(0); opacity: 0.3; }
  50%      { transform: translateY(8px); opacity: 0.8; }
}

/* ── Divider line ──────────────────────────────────────────── */
.divider {
  width: 100%;
  max-width: 1280px;
  margin: 0 auto;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--border-glow), transparent);
  position: relative;
  z-index: 1;
}

/* ── Layout ────────────────────────────────────────────────── */
.scrolly {
  display: flex;
  position: relative;
  max-width: 1320px;
  margin: 0 auto;
  z-index: 1;
}

.narrative {
  flex: 1 1 48%;
  padding: 0 2.5rem 0 3.5rem;
}

.viz-container {
  flex: 0 0 52%;
  position: sticky;
  top: 0;
  height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 2.5rem;
  /* Glow border on left edge */
  border-left: 1px solid var(--border);
}
.viz-container::before {
  content: '';
  position: absolute;
  left: -1px;
  top: 10%;
  bottom: 10%;
  width: 1px;
  background: linear-gradient(180deg, transparent, var(--cyan-dim), var(--cyan), var(--cyan-dim), transparent);
  opacity: 0.5;
}

/* ── Sections ──────────────────────────────────────────────── */
.section {
  min-height: 92vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  padding: 5rem 0;
  opacity: 0.12;
  transform: translateY(8px);
  transition: opacity 0.6s cubic-bezier(0.16, 1, 0.3, 1),
              transform 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}
.section.active {
  opacity: 1;
  transform: translateY(0);
}
.section h2 {
  font-family: var(--serif);
  font-size: 1.65rem;
  font-weight: 400;
  margin-bottom: 1.2rem;
  letter-spacing: -0.01em;
  line-height: 1.35;
  color: var(--text);
}
.section p {
  margin-bottom: 1rem;
  color: var(--text-dim);
  font-size: 0.95rem;
}
.section p em {
  color: var(--text);
  font-style: italic;
}
.section code {
  font-family: var(--mono);
  font-size: 0.8em;
  background: var(--bg-elevated);
  color: var(--cyan);
  padding: 0.15em 0.5em;
  border-radius: 4px;
  border: 1px solid var(--border);
}
.section .step-num {
  display: inline-block;
  font-family: var(--mono);
  font-size: 0.65rem;
  color: var(--text-muted);
  margin-bottom: 0.75rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  padding-bottom: 0.5rem;
  border-bottom: 1px solid var(--border);
}
.section .step-num .num {
  color: var(--cyan);
}

/* ── SVG Viz ───────────────────────────────────────────────── */
#viz {
  width: 100%;
  height: 80vh;
  max-height: 640px;
}

.viz-group {
  opacity: 0;
  transition: opacity 1s ease,
              transform 1s ease;
  transform: translateY(16px);
}
.viz-group.visible {
  opacity: 1;
  transform: translateY(0);
}

/* ── Outro ─────────────────────────────────────────────────── */
.outro {
  min-height: 50vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  text-align: center;
  padding: 6rem 2rem;
  position: relative;
  z-index: 1;
}
.outro::before {
  content: '';
  position: absolute;
  bottom: 30%;
  left: 50%;
  transform: translateX(-50%);
  width: 500px;
  height: 300px;
  background: radial-gradient(ellipse, rgba(0, 229, 255, 0.04) 0%, transparent 70%);
  pointer-events: none;
  z-index: -1;
}
.outro h2 {
  font-family: var(--serif);
  font-size: 1.8rem;
  font-weight: 400;
  color: var(--text);
  margin-bottom: 0.75rem;
}
.outro p {
  color: var(--text-dim);
  font-size: 1rem;
}

/* ── Responsive ────────────────────────────────────────────── */
@media (max-width: 900px) {
  .scrolly {
    flex-direction: column;
  }
  .narrative {
    padding: 0 1.5rem;
  }
  .viz-container {
    position: sticky;
    top: 0;
    height: 42vh;
    flex: none;
    order: -1;
    border-left: none;
    border-bottom: 1px solid var(--border);
    background: var(--bg-deep);
    z-index: 10;
  }
  .viz-container::before { display: none; }
  .section {
    min-height: 70vh;
    padding: 2.5rem 0;
  }
  .hero h1 { font-size: 2.4rem; }
  #viz { height: 38vh; max-height: 320px; }
  .step-indicator { display: none; }
}

@media (max-width: 500px) {
  html { font-size: 16px; }
  .hero h1 { font-size: 1.8rem; }
  .section h2 { font-size: 1.3rem; }
  .narrative { padding: 0 1rem; }
}
</style>
</head>
<body>

<!-- Scroll progress bar -->
<div class="progress-bar" id="progressBar"></div>

<!-- Step indicator dots -->
<nav class="step-indicator" id="stepIndicator">
  <div class="step-dot" data-target="1"></div>
  <div class="step-dot" data-target="2"></div>
  <div class="step-dot" data-target="3"></div>
  <div class="step-dot" data-target="4"></div>
  <div class="step-dot" data-target="5"></div>
  <div class="step-dot" data-target="6"></div>
  <div class="step-dot" data-target="7"></div>
  <div class="step-dot" data-target="8"></div>
  <div class="step-dot" data-target="9"></div>
  <div class="step-dot" data-target="10"></div>
</nav>

<!-- ═══════════════════════ HERO ═══════════════════════════ -->
<header class="hero">
  <p class="hero-label">Data Governance Infrastructure</p>
  <h1>The <em>Policy Engine</em></h1>
  <p class="subtitle">
    Why PostgreSQL row-level security needs a compiler &mdash;
    and how a small algebra makes data governance provable.
  </p>
  <div class="scroll-hint">
    Scroll to explore
    <span class="arrow">&darr;</span>
  </div>
</header>

<div class="divider"></div>

<!-- ═══════════════════════ SCROLLY ════════════════════════ -->
<div class="scrolly">

  <!-- ── Narrative Column ── -->
  <div class="narrative">

    <!-- Section 1 -->
    <div class="section" data-step="1">
      <span class="step-num"><span class="num">01</span> &mdash; The Problem</span>
      <h2>Your database has a security policy problem</h2>
      <p>
        You have a PostgreSQL database powering a multi-tenant SaaS app.
        You&rsquo;ve written RLS policies to keep tenants isolated. You&rsquo;ve
        added <code>GRANT</code>s for different roles. It works &mdash; you
        think. But can you <em>prove</em> it?
      </p>
    </div>

    <!-- Section 2 -->
    <div class="section" data-step="2">
      <span class="step-num"><span class="num">02</span> &mdash; Complexity</span>
      <h2>Policies are code, and code is complex</h2>
      <p>
        Each RLS policy is arbitrary SQL. It can call functions, read session
        state, use subqueries. When you have 5 tables, it&rsquo;s manageable.
        When you have 50, with overlapping policies, different roles,
        permissive vs restrictive modes &mdash; the combinatorial explosion
        makes it impossible to reason about.
      </p>
    </div>

    <!-- Section 3 -->
    <div class="section" data-step="3">
      <span class="step-num"><span class="num">03</span> &mdash; The Limit</span>
      <h2>The fundamental limit</h2>
      <p>
        This isn&rsquo;t a tooling gap &mdash; it&rsquo;s a theoretical one. RLS
        predicates can contain arbitrary SQL, which is Turing-complete. Statically
        determining which rows a user can access is equivalent to the halting
        problem. No visualization tool can authoritatively answer &ldquo;is
        tenant isolation preserved?&rdquo; for arbitrary RLS.
      </p>
    </div>

    <!-- Section 4 -->
    <div class="section" data-step="4">
      <span class="step-num"><span class="num">04</span> &mdash; The Insight</span>
      <h2>Don&rsquo;t analyze RLS &mdash; generate it</h2>
      <p>
        Instead of trying to understand arbitrary SQL policies after the fact,
        define policies in a constrained language where reasoning is possible,
        then <em>compile</em> to SQL. RLS becomes a backend target, not the
        authoring surface.
      </p>
      <p>
        This is the same architectural pattern as:<br>
        <code>source code &rarr; compiler &rarr; machine code</code>
      </p>
    </div>

    <!-- Section 5 -->
    <div class="section" data-step="5">
      <span class="step-num"><span class="num">05</span> &mdash; The Algebra</span>
      <h2>Structured predicates: the policy algebra</h2>
      <p>
        Policies are built from <em>atoms</em> &mdash; structured comparisons
        like <code>tenant_id = session('app.tenant_id')</code>. Atoms combine
        into <em>clauses</em> (AND). Multiple policies on a table compose via
        PostgreSQL&rsquo;s own semantics: permissive policies OR together,
        restrictive policies AND together.
      </p>
      <p>
        This gives a formal algebra:
        <code>(&or; permissive) &and; (&and; restrictive)</code>
      </p>
    </div>

    <!-- Section 6 -->
    <div class="section" data-step="6">
      <span class="step-num"><span class="num">06</span> &mdash; Fan-Out</span>
      <h2>One policy, many tables</h2>
      <p>
        A single tenant-isolation policy doesn&rsquo;t list every table. It
        declares a <em>selector</em>: &ldquo;all tables with a
        <code>tenant_id</code> column.&rdquo; New tables matching the selector
        are automatically covered.
      </p>
      <p>
        Policies also flow through declared relationships &mdash; access to a
        project implies access to its tasks, via <code>EXISTS</code>
        subqueries.
      </p>
    </div>

    <!-- Section 7 -->
    <div class="section" data-step="7">
      <span class="step-num"><span class="num">07</span> &mdash; Provability</span>
      <h2>Prove it before you ship it</h2>
      <p>
        Because the algebra is decidable, you can analyze policies at design
        time. Is this policy satisfiable, or did you write a contradiction?
        Does policy A make policy B redundant? Is tenant isolation actually
        guaranteed?
      </p>
      <p>
        These become answerable questions &mdash; theorems you can prove, not
        hopes you hold.
      </p>
    </div>

    <!-- Section 8 -->
    <div class="section" data-step="8">
      <span class="step-num"><span class="num">08</span> &mdash; Optimization</span>
      <h2>Optimize like a query planner</h2>
      <p>
        The algebra supports rewrite rules &mdash; simplifications analogous to
        what a SQL query planner does with relational algebra. Redundant
        conditions are eliminated. Contradictions are caught. Overlapping
        policies are merged. The system produces the simplest correct
        enforcement.
      </p>
    </div>

    <!-- Section 9 -->
    <div class="section" data-step="9">
      <span class="step-num"><span class="num">09</span> &mdash; Compilation</span>
      <h2>Algebra &rarr; PostgreSQL</h2>
      <p>
        The final step is deterministic compilation to native PostgreSQL
        artifacts. Object access policies become <code>GRANT</code>s. Row
        security policies become <code>CREATE POLICY</code> with
        <code>USING</code>/<code>WITH CHECK</code> clauses. Relationship
        fan-out becomes <code>EXISTS</code> subqueries.
      </p>
      <p>
        No proxy layer &mdash; enforcement happens inside PostgreSQL.
      </p>
    </div>

    <!-- Section 10 -->
    <div class="section" data-step="10">
      <span class="step-num"><span class="num">10</span> &mdash; The Loop</span>
      <h2>The closed loop</h2>
      <p>
        Policy intent &rarr; compile &rarr; enforce &rarr; detect drift &rarr;
        reconcile. Data stewards define what they want. The engine proves
        it&rsquo;s consistent, compiles it to SQL, applies it, and continuously
        monitors for drift.
      </p>
      <p>
        A complete governance loop, not a one-time script.
      </p>
    </div>

  </div><!-- /narrative -->

  <!-- ── Visualization Column ── -->
  <div class="viz-container">
    <svg id="viz" viewBox="0 0 500 500" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <marker id="arrow" viewBox="0 0 10 10" refX="9" refY="5"
                markerWidth="6" markerHeight="6" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="#4a5e7a"/>
        </marker>
        <marker id="arrow-cyan" viewBox="0 0 10 10" refX="9" refY="5"
                markerWidth="6" markerHeight="6" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--cyan)"/>
        </marker>
        <marker id="arrow-teal" viewBox="0 0 10 10" refX="9" refY="5"
                markerWidth="6" markerHeight="6" orient="auto-start-reverse">
          <path d="M 0 0 L 10 5 L 0 10 z" fill="var(--teal)"/>
        </marker>

        <!-- Glow filters -->
        <filter id="glow-cyan" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="3" result="blur"/>
          <feFlood flood-color="#00e5ff" flood-opacity="0.3" result="color"/>
          <feComposite in="color" in2="blur" operator="in" result="glow"/>
          <feMerge>
            <feMergeNode in="glow"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        <filter id="glow-teal" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="3" result="blur"/>
          <feFlood flood-color="#2dd4a8" flood-opacity="0.3" result="color"/>
          <feComposite in="color" in2="blur" operator="in" result="glow"/>
          <feMerge>
            <feMergeNode in="glow"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        <filter id="glow-red" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="3" result="blur"/>
          <feFlood flood-color="#ff4757" flood-opacity="0.3" result="color"/>
          <feComposite in="color" in2="blur" operator="in" result="glow"/>
          <feMerge>
            <feMergeNode in="glow"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        <filter id="glow-amber" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="3" result="blur"/>
          <feFlood flood-color="#ffb800" flood-opacity="0.25" result="color"/>
          <feComposite in="color" in2="blur" operator="in" result="glow"/>
          <feMerge>
            <feMergeNode in="glow"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>
        <filter id="soft-shadow" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="#000" flood-opacity="0.4"/>
        </filter>
      </defs>

      <!-- ═══ STEP 1: Clean schema ═══ -->
      <g id="step1" class="viz-group">
        <!-- Tables -->
        <g filter="url(#soft-shadow)">
          <rect x="60" y="100" width="120" height="50" rx="6" fill="var(--bg-card)" stroke="var(--teal)" stroke-width="1.5"/>
          <text x="120" y="130" text-anchor="middle" font-family="var(--mono)" font-size="13" fill="var(--teal)">users</text>
        </g>
        <g filter="url(#soft-shadow)">
          <rect x="320" y="100" width="120" height="50" rx="6" fill="var(--bg-card)" stroke="var(--teal)" stroke-width="1.5"/>
          <text x="380" y="130" text-anchor="middle" font-family="var(--mono)" font-size="13" fill="var(--teal)">projects</text>
        </g>
        <g filter="url(#soft-shadow)">
          <rect x="190" y="260" width="120" height="50" rx="6" fill="var(--bg-card)" stroke="var(--teal)" stroke-width="1.5"/>
          <text x="250" y="290" text-anchor="middle" font-family="var(--mono)" font-size="13" fill="var(--teal)">tasks</text>
        </g>

        <!-- FK arrows -->
        <line x1="180" y1="125" x2="320" y2="125" stroke="var(--border-glow)" stroke-width="1.5" marker-end="url(#arrow)"/>
        <line x1="380" y1="150" x2="310" y2="260" stroke="var(--border-glow)" stroke-width="1.5" marker-end="url(#arrow)"/>

        <!-- RLS badges -->
        <rect x="80" y="157" width="80" height="22" rx="11" fill="var(--teal)" opacity="0.1" stroke="var(--teal)" stroke-width="0.5"/>
        <text x="120" y="172" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--teal)">RLS policy</text>

        <rect x="340" y="157" width="80" height="22" rx="11" fill="var(--teal)" opacity="0.1" stroke="var(--teal)" stroke-width="0.5"/>
        <text x="380" y="172" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--teal)">RLS policy</text>

        <rect x="210" y="317" width="80" height="22" rx="11" fill="var(--teal)" opacity="0.1" stroke="var(--teal)" stroke-width="0.5"/>
        <text x="250" y="332" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--teal)">RLS policy</text>

        <!-- Caption -->
        <text x="250" y="420" text-anchor="middle" font-family="var(--sans)" font-size="12" fill="var(--text-muted)">3 tables, 3 policies. Looks manageable.</text>
      </g>

      <!-- ═══ STEP 2: Spaghetti ═══ -->
      <g id="step2" class="viz-group">
        <!-- Many small tables -->
        <g id="step2-tables">
          <rect x="30"  y="30"  width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--amber)" stroke-width="1" opacity="0.9"/>
          <text x="65"  y="50"  text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--amber)">users</text>
          <rect x="120" y="30"  width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--amber)" stroke-width="1" opacity="0.9"/>
          <text x="155" y="50"  text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--amber)">projects</text>
          <rect x="210" y="30"  width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--amber)" stroke-width="1" opacity="0.9"/>
          <text x="245" y="50"  text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--amber)">tasks</text>
          <rect x="300" y="30"  width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--red)" stroke-width="1" opacity="0.9"/>
          <text x="335" y="50"  text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--red)">comments</text>
          <rect x="390" y="30"  width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--red)" stroke-width="1" opacity="0.9"/>
          <text x="425" y="50"  text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--red)">files</text>

          <rect x="30"  y="100" width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--amber)" stroke-width="1" opacity="0.9"/>
          <text x="65"  y="120" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--amber)">roles</text>
          <rect x="120" y="100" width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--red)" stroke-width="1" opacity="0.9"/>
          <text x="155" y="120" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--red)">tenants</text>
          <rect x="210" y="100" width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--amber)" stroke-width="1" opacity="0.9"/>
          <text x="245" y="120" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--amber)">invoices</text>
          <rect x="300" y="100" width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--red)" stroke-width="1" opacity="0.9"/>
          <text x="335" y="120" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--red)">payments</text>
          <rect x="390" y="100" width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--amber)" stroke-width="1" opacity="0.9"/>
          <text x="425" y="120" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--amber)">audit_log</text>

          <rect x="30"  y="170" width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--red)" stroke-width="1" opacity="0.9"/>
          <text x="65"  y="190" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--red)">settings</text>
          <rect x="120" y="170" width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--amber)" stroke-width="1" opacity="0.9"/>
          <text x="155" y="190" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--amber)">tags</text>
          <rect x="210" y="170" width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--red)" stroke-width="1" opacity="0.9"/>
          <text x="245" y="190" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--red)">sessions</text>
          <rect x="300" y="170" width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--amber)" stroke-width="1" opacity="0.9"/>
          <text x="335" y="190" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--amber)">webhooks</text>
          <rect x="390" y="170" width="70" height="30" rx="4" fill="var(--bg-card)" stroke="var(--red)" stroke-width="1" opacity="0.9"/>
          <text x="425" y="190" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--red)">api_keys</text>
        </g>

        <!-- Tangled lines -->
        <g opacity="0.3">
          <line x1="100" y1="45"  x2="120" y2="45"  stroke="var(--amber)" stroke-width="1"/>
          <line x1="190" y1="45"  x2="210" y2="45"  stroke="var(--amber)" stroke-width="1"/>
          <line x1="280" y1="45"  x2="300" y2="45"  stroke="var(--red)" stroke-width="1"/>
          <line x1="370" y1="45"  x2="390" y2="45"  stroke="var(--red)" stroke-width="1"/>
          <line x1="65"  y1="60"  x2="155" y2="100" stroke="var(--amber)" stroke-width="1"/>
          <line x1="155" y1="60"  x2="245" y2="100" stroke="var(--amber)" stroke-width="1"/>
          <line x1="245" y1="60"  x2="335" y2="100" stroke="var(--red)" stroke-width="1"/>
          <line x1="335" y1="60"  x2="425" y2="100" stroke="var(--red)" stroke-width="1"/>
          <line x1="425" y1="60"  x2="65"  y2="100" stroke="var(--amber)" stroke-width="1"/>
          <line x1="65"  y1="130" x2="155" y2="170" stroke="var(--amber)" stroke-width="1"/>
          <line x1="155" y1="130" x2="245" y2="170" stroke="var(--red)" stroke-width="1"/>
          <line x1="245" y1="130" x2="335" y2="170" stroke="var(--amber)" stroke-width="1"/>
          <line x1="335" y1="130" x2="425" y2="170" stroke="var(--red)" stroke-width="1"/>
          <line x1="425" y1="130" x2="65"  y2="170" stroke="var(--red)" stroke-width="1"/>
          <line x1="100" y1="115" x2="300" y2="185" stroke="var(--red)" stroke-width="1"/>
          <line x1="190" y1="115" x2="390" y2="185" stroke="var(--amber)" stroke-width="1"/>
          <line x1="370" y1="45"  x2="65"  y2="170" stroke="var(--red)" stroke-width="1" opacity="0.5"/>
          <line x1="100" y1="45"  x2="425" y2="170" stroke="var(--amber)" stroke-width="1" opacity="0.5"/>
        </g>

        <!-- Overlapping policy badges -->
        <g>
          <rect x="50"  y="232" width="55" height="18" rx="9" fill="var(--amber)" opacity="0.15"/>
          <text x="77"  y="245" text-anchor="middle" font-family="var(--mono)" font-size="7" fill="var(--amber)">policy A</text>
          <rect x="95"  y="232" width="55" height="18" rx="9" fill="var(--red)" opacity="0.15"/>
          <text x="122" y="245" text-anchor="middle" font-family="var(--mono)" font-size="7" fill="var(--red)">policy B</text>
          <rect x="140" y="232" width="55" height="18" rx="9" fill="var(--amber)" opacity="0.15"/>
          <text x="167" y="245" text-anchor="middle" font-family="var(--mono)" font-size="7" fill="var(--amber)">policy C</text>
          <rect x="185" y="232" width="55" height="18" rx="9" fill="var(--red)" opacity="0.15"/>
          <text x="212" y="245" text-anchor="middle" font-family="var(--mono)" font-size="7" fill="var(--red)">policy D</text>
          <rect x="230" y="232" width="55" height="18" rx="9" fill="var(--amber)" opacity="0.15"/>
          <text x="257" y="245" text-anchor="middle" font-family="var(--mono)" font-size="7" fill="var(--amber)">policy E</text>
          <rect x="275" y="232" width="80" height="18" rx="9" fill="var(--red)" opacity="0.15"/>
          <text x="315" y="245" text-anchor="middle" font-family="var(--mono)" font-size="7" fill="var(--red)">restrictive F</text>
          <rect x="345" y="232" width="80" height="18" rx="9" fill="var(--red)" opacity="0.15"/>
          <text x="385" y="245" text-anchor="middle" font-family="var(--mono)" font-size="7" fill="var(--red)">permissive G</text>
        </g>

        <!-- Color legend -->
        <text x="250" y="310" text-anchor="middle" font-family="var(--mono)" font-size="11" fill="var(--teal)">5 tables: confident</text>
        <text x="250" y="332" text-anchor="middle" font-family="var(--mono)" font-size="11" fill="var(--amber)">20 tables: uncertain</text>
        <text x="250" y="354" text-anchor="middle" font-family="var(--mono)" font-size="11" fill="var(--red)">50 tables: unknowable</text>

        <text x="250" y="420" text-anchor="middle" font-family="var(--sans)" font-size="12" fill="var(--text-muted)">Combinatorial explosion.</text>
      </g>

      <!-- ═══ STEP 3: Undecidable ═══ -->
      <g id="step3" class="viz-group">
        <!-- Lock with question mark -->
        <g transform="translate(250, 150)" filter="url(#glow-red)">
          <!-- Lock body -->
          <rect x="-45" y="0" width="90" height="65" rx="10" fill="var(--bg-card)" stroke="var(--red)" stroke-width="1.5" opacity="0.8"/>
          <!-- Lock shackle -->
          <path d="M -22 0 L -22 -28 A 22 22 0 0 1 22 -28 L 22 0" fill="none" stroke="var(--red)" stroke-width="4" opacity="0.5"/>
          <!-- Question mark -->
          <text x="0" y="46" text-anchor="middle" font-family="var(--serif)" font-size="36" font-weight="700" fill="var(--red)">?</text>
        </g>

        <!-- Equation -->
        <text x="250" y="280" text-anchor="middle" font-family="var(--mono)" font-size="15" fill="var(--text)">Arbitrary SQL</text>
        <text x="250" y="312" text-anchor="middle" font-family="var(--sans)" font-size="24" fill="var(--red)" opacity="0.7">&darr;</text>
        <g filter="url(#glow-red)">
          <text x="250" y="345" text-anchor="middle" font-family="var(--mono)" font-size="16" font-weight="600" fill="var(--red)">Undecidable</text>
        </g>

        <text x="250" y="420" text-anchor="middle" font-family="var(--sans)" font-size="12" fill="var(--text-muted)">Equivalent to the halting problem.</text>
      </g>

      <!-- ═══ STEP 4: Compiler metaphor ═══ -->
      <g id="step4" class="viz-group">
        <!-- Source box -->
        <g filter="url(#soft-shadow)">
          <rect x="35" y="165" width="140" height="85" rx="8" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1.5"/>
          <text x="105" y="195" text-anchor="middle" font-family="var(--mono)" font-size="12" fill="var(--cyan)">Policy DSL</text>
          <text x="105" y="215" text-anchor="middle" font-family="var(--sans)" font-size="10" fill="var(--text-dim)">constrained</text>
          <text x="105" y="232" text-anchor="middle" font-family="var(--sans)" font-size="10" fill="var(--text-dim)">decidable</text>
        </g>

        <!-- Arrow -->
        <line x1="185" y1="207" x2="310" y2="207" stroke="var(--cyan)" stroke-width="2" stroke-dasharray="6 3" marker-end="url(#arrow-cyan)"/>
        <g filter="url(#glow-cyan)">
          <text x="248" y="195" text-anchor="middle" font-family="var(--mono)" font-size="11" font-weight="600" fill="var(--cyan)">compile</text>
        </g>

        <!-- Target box -->
        <g filter="url(#soft-shadow)">
          <rect x="320" y="165" width="140" height="85" rx="8" fill="var(--bg-card)" stroke="var(--border-glow)" stroke-width="1.5"/>
          <text x="390" y="195" text-anchor="middle" font-family="var(--mono)" font-size="12" fill="var(--text)">SQL / RLS</text>
          <text x="390" y="215" text-anchor="middle" font-family="var(--mono)" font-size="9" fill="var(--text-dim)">GRANT, CREATE POLICY</text>
          <text x="390" y="232" text-anchor="middle" font-family="var(--mono)" font-size="9" fill="var(--text-dim)">USING, WITH CHECK</text>
        </g>

        <!-- Analogy -->
        <text x="250" y="310" text-anchor="middle" font-family="var(--sans)" font-size="12" fill="var(--text-muted)">Same pattern as:</text>
        <text x="250" y="335" text-anchor="middle" font-family="var(--mono)" font-size="11" fill="var(--text-dim)">source &rarr; compiler &rarr; machine code</text>

        <text x="250" y="420" text-anchor="middle" font-family="var(--sans)" font-size="12" fill="var(--text-muted)">RLS is a compile target, not the authoring surface.</text>
      </g>

      <!-- ═══ STEP 5: Policy algebra ═══ -->
      <g id="step5" class="viz-group">
        <!-- Atom 1 -->
        <rect x="50" y="80" width="180" height="36" rx="18" fill="var(--cyan-dim)" stroke="var(--cyan)" stroke-width="1"/>
        <text x="140" y="103" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--cyan)">tenant_id = session(tid)</text>

        <!-- AND -->
        <text x="250" y="137" text-anchor="middle" font-family="var(--mono)" font-size="13" font-weight="700" fill="var(--text-dim)">AND</text>

        <!-- Atom 2 -->
        <rect x="50" y="150" width="180" height="36" rx="18" fill="var(--cyan-dim)" stroke="var(--cyan)" stroke-width="1"/>
        <text x="140" y="173" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--cyan)">role = 'editor'</text>

        <!-- Bracket for clause -->
        <text x="30" y="135" text-anchor="middle" font-family="var(--sans)" font-size="80" fill="var(--cyan)" opacity="0.12">}</text>
        <text x="248" y="62" text-anchor="middle" font-family="var(--sans)" font-size="10" fill="var(--text-muted)">Clause (AND of atoms)</text>

        <!-- Permissive OR -->
        <rect x="270" y="80" width="180" height="36" rx="18" fill="var(--teal-dim)" stroke="var(--teal)" stroke-width="1"/>
        <text x="360" y="103" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--teal)">is_admin = true</text>

        <g filter="url(#glow-teal)">
          <text x="250" y="213" text-anchor="middle" font-family="var(--mono)" font-size="13" font-weight="700" fill="var(--teal)">OR (permissive)</text>
        </g>

        <!-- Combined -->
        <rect x="80" y="240" width="340" height="40" rx="8" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1" stroke-dasharray="4"/>
        <text x="250" y="265" text-anchor="middle" font-family="var(--mono)" font-size="9.5" fill="var(--cyan)">(tenant_id=tid AND role='editor') OR (is_admin)</text>

        <!-- Restrictive AND -->
        <text x="250" y="310" text-anchor="middle" font-family="var(--mono)" font-size="13" font-weight="700" fill="var(--red)">AND (restrictive)</text>

        <rect x="120" y="325" width="260" height="36" rx="18" fill="var(--red-dim)" stroke="var(--red)" stroke-width="1"/>
        <text x="250" y="348" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--red)">NOT is_deleted</text>

        <!-- Formula -->
        <g filter="url(#glow-cyan)">
          <text x="250" y="425" text-anchor="middle" font-family="var(--mono)" font-size="13" fill="var(--cyan)">(&or; permissive) &and; (&and; restrictive)</text>
        </g>
      </g>

      <!-- ═══ STEP 6: Fan-out ═══ -->
      <g id="step6" class="viz-group">
        <!-- Policy source -->
        <g filter="url(#glow-cyan)">
          <rect x="170" y="40" width="160" height="45" rx="8" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1.5"/>
          <text x="250" y="58" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--cyan)">tenant_isolation</text>
          <text x="250" y="75" text-anchor="middle" font-family="var(--sans)" font-size="9" fill="var(--text-dim)">selector: has tenant_id</text>
        </g>

        <!-- Fan-out arrows -->
        <line x1="200" y1="85" x2="80"  y2="140" stroke="var(--cyan)" stroke-width="1" opacity="0.6" marker-end="url(#arrow-cyan)"/>
        <line x1="230" y1="85" x2="200" y2="140" stroke="var(--cyan)" stroke-width="1" opacity="0.6" marker-end="url(#arrow-cyan)"/>
        <line x1="270" y1="85" x2="310" y2="140" stroke="var(--cyan)" stroke-width="1" opacity="0.6" marker-end="url(#arrow-cyan)"/>
        <line x1="300" y1="85" x2="420" y2="140" stroke="var(--cyan)" stroke-width="1" opacity="0.6" marker-end="url(#arrow-cyan)"/>

        <!-- Tables with tenant_id (lit up) -->
        <g filter="url(#soft-shadow)">
          <rect x="30"  y="140" width="100" height="40" rx="6" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1.5"/>
          <text x="80"  y="165" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--cyan)">users</text>
        </g>
        <g filter="url(#soft-shadow)">
          <rect x="150" y="140" width="100" height="40" rx="6" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1.5"/>
          <text x="200" y="165" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--cyan)">projects</text>
        </g>
        <g filter="url(#soft-shadow)">
          <rect x="260" y="140" width="100" height="40" rx="6" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1.5"/>
          <text x="310" y="165" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--cyan)">invoices</text>
        </g>
        <g filter="url(#soft-shadow)">
          <rect x="370" y="140" width="100" height="40" rx="6" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1.5"/>
          <text x="420" y="165" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--cyan)">payments</text>
        </g>

        <!-- Relationship: projects → tasks (inherited) -->
        <line x1="200" y1="180" x2="200" y2="250" stroke="var(--teal)" stroke-width="1.5" stroke-dasharray="4" marker-end="url(#arrow-teal)"/>
        <text x="217" y="220" font-family="var(--mono)" font-size="8" fill="var(--teal)">FK</text>

        <g filter="url(#soft-shadow)">
          <rect x="150" y="250" width="100" height="40" rx="6" fill="var(--bg-card)" stroke="var(--teal)" stroke-width="1.5"/>
          <text x="200" y="275" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--teal)">tasks</text>
        </g>
        <text x="200" y="305" text-anchor="middle" font-family="var(--sans)" font-size="9" fill="var(--teal)">inherited via EXISTS</text>

        <!-- Dim table without tenant_id -->
        <rect x="370" y="250" width="100" height="40" rx="6" fill="var(--bg-card)" stroke="var(--border)" stroke-width="1" opacity="0.4"/>
        <text x="420" y="275" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--text-muted)" opacity="0.5">config</text>
        <text x="420" y="305" text-anchor="middle" font-family="var(--sans)" font-size="9" fill="var(--text-muted)" opacity="0.4">no tenant_id</text>

        <text x="250" y="420" text-anchor="middle" font-family="var(--sans)" font-size="12" fill="var(--text-muted)">Selector matches tables automatically.</text>
      </g>

      <!-- ═══ STEP 7: Provability checklist ═══ -->
      <g id="step7" class="viz-group">
        <text x="250" y="65" text-anchor="middle" font-family="var(--serif)" font-size="15" fill="var(--text)">Design-time analysis</text>

        <!-- Checklist -->
        <g transform="translate(100, 95)">
          <!-- Item 1: Satisfiable -->
          <rect x="0" y="0" width="300" height="48" rx="8" fill="var(--teal)" opacity="0.05" stroke="var(--teal)" stroke-width="0.5"/>
          <text x="20" y="30" font-family="var(--sans)" font-size="13" fill="var(--text-dim)">Policy is satisfiable?</text>
          <g filter="url(#glow-teal)">
            <text x="275" y="32" text-anchor="middle" font-family="var(--sans)" font-size="20" fill="var(--teal)">&#10003;</text>
          </g>

          <!-- Item 2: Isolation -->
          <rect x="0" y="58" width="300" height="48" rx="8" fill="var(--teal)" opacity="0.05" stroke="var(--teal)" stroke-width="0.5"/>
          <text x="20" y="88" font-family="var(--sans)" font-size="13" fill="var(--text-dim)">Tenant isolation guaranteed?</text>
          <g filter="url(#glow-teal)">
            <text x="275" y="90" text-anchor="middle" font-family="var(--sans)" font-size="20" fill="var(--teal)">&#10003;</text>
          </g>

          <!-- Item 3: No redundancy -->
          <rect x="0" y="116" width="300" height="48" rx="8" fill="var(--teal)" opacity="0.05" stroke="var(--teal)" stroke-width="0.5"/>
          <text x="20" y="146" font-family="var(--sans)" font-size="13" fill="var(--text-dim)">No redundant policies?</text>
          <g filter="url(#glow-teal)">
            <text x="275" y="148" text-anchor="middle" font-family="var(--sans)" font-size="20" fill="var(--teal)">&#10003;</text>
          </g>

          <!-- Item 4: Contradiction caught -->
          <rect x="0" y="174" width="300" height="48" rx="8" fill="var(--red)" opacity="0.05" stroke="var(--red)" stroke-width="0.5"/>
          <text x="20" y="204" font-family="var(--sans)" font-size="13" fill="var(--text-dim)">Contradictory policy detected</text>
          <g filter="url(#glow-red)">
            <text x="275" y="206" text-anchor="middle" font-family="var(--sans)" font-size="20" fill="var(--red)">&#10007;</text>
          </g>
        </g>

        <!-- Caught before deploy -->
        <g transform="translate(135, 335)">
          <rect x="0" y="0" width="230" height="35" rx="6" fill="var(--red-dim)" stroke="var(--red)" stroke-width="1" stroke-dasharray="4"/>
          <text x="115" y="22" text-anchor="middle" font-family="var(--mono)" font-size="11" fill="var(--red)">Caught before deployment</text>
        </g>

        <text x="250" y="420" text-anchor="middle" font-family="var(--sans)" font-size="12" fill="var(--text-muted)">Theorems, not hopes.</text>
      </g>

      <!-- ═══ STEP 8: Optimization rewrite ═══ -->
      <g id="step8" class="viz-group">
        <text x="250" y="45" text-anchor="middle" font-family="var(--serif)" font-size="15" fill="var(--text)">Rewrite rules simplify policies</text>

        <!-- Before label -->
        <text x="125" y="80" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--text-muted)">before</text>
        <rect x="30" y="95"  width="190" height="30" rx="15" fill="var(--amber-dim)" stroke="var(--amber)" stroke-width="0.8"/>
        <text x="125" y="115" text-anchor="middle" font-family="var(--mono)" font-size="9" fill="var(--amber)">tenant_id = $tid</text>
        <rect x="30" y="135" width="190" height="30" rx="15" fill="var(--amber-dim)" stroke="var(--amber)" stroke-width="0.8"/>
        <text x="125" y="155" text-anchor="middle" font-family="var(--mono)" font-size="9" fill="var(--amber)">tenant_id = $tid AND active</text>
        <rect x="30" y="175" width="190" height="30" rx="15" fill="var(--red-dim)" stroke="var(--red)" stroke-width="0.8"/>
        <text x="125" y="195" text-anchor="middle" font-family="var(--mono)" font-size="9" fill="var(--red)">role='admin' AND role='viewer'</text>
        <rect x="30" y="215" width="190" height="30" rx="15" fill="var(--amber-dim)" stroke="var(--amber)" stroke-width="0.8"/>
        <text x="125" y="235" text-anchor="middle" font-family="var(--mono)" font-size="9" fill="var(--amber)">NOT is_deleted</text>

        <!-- Arrow -->
        <g filter="url(#glow-cyan)">
          <text x="250" y="177" text-anchor="middle" font-family="var(--sans)" font-size="26" fill="var(--cyan)">&rarr;</text>
        </g>

        <!-- After label -->
        <text x="375" y="80" text-anchor="middle" font-family="var(--mono)" font-size="10" fill="var(--text-muted)">after</text>
        <rect x="280" y="95"  width="190" height="30" rx="15" fill="var(--teal-dim)" stroke="var(--teal)" stroke-width="1"/>
        <text x="375" y="115" text-anchor="middle" font-family="var(--mono)" font-size="9" fill="var(--teal)">tenant_id = $tid AND active</text>
        <rect x="280" y="135" width="190" height="30" rx="15" fill="var(--teal-dim)" stroke="var(--teal)" stroke-width="1"/>
        <text x="375" y="155" text-anchor="middle" font-family="var(--mono)" font-size="9" fill="var(--teal)">NOT is_deleted</text>

        <!-- Annotations -->
        <text x="375" y="193" text-anchor="middle" font-family="var(--sans)" font-size="10" fill="var(--text-muted)">redundant atom absorbed</text>
        <text x="375" y="213" text-anchor="middle" font-family="var(--sans)" font-size="10" fill="var(--red)">contradiction eliminated</text>

        <!-- Summary box -->
        <g transform="translate(100, 290)">
          <rect x="0" y="0" width="300" height="55" rx="8" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1" stroke-dasharray="4"/>
          <text x="150" y="22" text-anchor="middle" font-family="var(--mono)" font-size="11" fill="var(--cyan)">4 atoms &rarr; 2 atoms</text>
          <text x="150" y="42" text-anchor="middle" font-family="var(--sans)" font-size="11" fill="var(--text-dim)">Simplest correct enforcement</text>
        </g>

        <text x="250" y="420" text-anchor="middle" font-family="var(--sans)" font-size="12" fill="var(--text-muted)">Like a query planner for policies.</text>
      </g>

      <!-- ═══ STEP 9: Compilation ═══ -->
      <g id="step9" class="viz-group">
        <!-- Source policy (left) -->
        <g filter="url(#soft-shadow)">
          <rect x="20" y="60" width="180" height="220" rx="8" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1.5"/>
          <text x="110" y="85" text-anchor="middle" font-family="var(--mono)" font-size="10" font-weight="600" fill="var(--cyan)">Policy DSL</text>

          <text x="35" y="115" font-family="var(--mono)" font-size="9" fill="var(--text)">object_access:</text>
          <text x="45" y="132" font-family="var(--mono)" font-size="9" fill="var(--text-dim)">tables: [users]</text>
          <text x="45" y="149" font-family="var(--mono)" font-size="9" fill="var(--text-dim)">role: app_reader</text>
          <text x="35" y="175" font-family="var(--mono)" font-size="9" fill="var(--text)">row_security:</text>
          <text x="45" y="192" font-family="var(--mono)" font-size="9" fill="var(--text-dim)">tenant_id = $tid</text>
          <text x="35" y="218" font-family="var(--mono)" font-size="9" fill="var(--text)">fan_out:</text>
          <text x="45" y="235" font-family="var(--mono)" font-size="9" fill="var(--text-dim)">projects &rarr; tasks</text>
        </g>

        <!-- Arrow -->
        <line x1="210" y1="170" x2="290" y2="170" stroke="var(--cyan)" stroke-width="2" stroke-dasharray="6 3" marker-end="url(#arrow-cyan)"/>
        <g filter="url(#glow-cyan)">
          <text x="250" y="158" text-anchor="middle" font-family="var(--mono)" font-size="10" font-weight="600" fill="var(--cyan)">compile</text>
        </g>

        <!-- SQL output (right) -->
        <g filter="url(#soft-shadow)">
          <rect x="300" y="60" width="185" height="220" rx="8" fill="var(--bg-card)" stroke="var(--border-glow)" stroke-width="1.5"/>
          <text x="392" y="85" text-anchor="middle" font-family="var(--mono)" font-size="10" font-weight="600" fill="var(--text)">PostgreSQL</text>

          <text x="315" y="115" font-family="var(--mono)" font-size="8.5" fill="var(--teal)">GRANT SELECT</text>
          <text x="325" y="130" font-family="var(--mono)" font-size="8.5" fill="var(--teal)">ON users TO app_reader;</text>

          <text x="315" y="158" font-family="var(--mono)" font-size="8.5" fill="var(--cyan)">CREATE POLICY iso</text>
          <text x="325" y="173" font-family="var(--mono)" font-size="8.5" fill="var(--cyan)">ON users USING</text>
          <text x="325" y="188" font-family="var(--mono)" font-size="8.5" fill="var(--cyan)">(tenant_id=cur..tid);</text>

          <text x="315" y="216" font-family="var(--mono)" font-size="8.5" fill="var(--text-dim)">CREATE POLICY fanout</text>
          <text x="325" y="231" font-family="var(--mono)" font-size="8.5" fill="var(--text-dim)">ON tasks USING</text>
          <text x="325" y="246" font-family="var(--mono)" font-size="8.5" fill="var(--text-dim)">(EXISTS(SELECT 1..));</text>
        </g>

        <!-- Mapping lines -->
        <line x1="200" y1="122" x2="300" y2="122" stroke="var(--teal)" stroke-width="0.8" stroke-dasharray="3" opacity="0.4"/>
        <line x1="200" y1="183" x2="300" y2="173" stroke="var(--cyan)" stroke-width="0.8" stroke-dasharray="3" opacity="0.4"/>
        <line x1="200" y1="228" x2="300" y2="228" stroke="var(--text-muted)" stroke-width="0.8" stroke-dasharray="3" opacity="0.3"/>

        <text x="250" y="340" text-anchor="middle" font-family="var(--sans)" font-size="12" fill="var(--text-muted)">Each piece maps to a specific SQL construct.</text>
        <text x="250" y="365" text-anchor="middle" font-family="var(--sans)" font-size="11" fill="var(--text-dim)">No proxy layer. Enforcement inside PostgreSQL.</text>
      </g>

      <!-- ═══ STEP 10: Closed loop ═══ -->
      <g id="step10" class="viz-group">
        <text x="250" y="45" text-anchor="middle" font-family="var(--serif)" font-size="15" fill="var(--text)">The governance loop</text>

        <!-- Node: Define (top) -->
        <g id="loop-define">
          <circle cx="250" cy="110" r="34" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1.5"/>
          <text x="250" y="106" text-anchor="middle" font-family="var(--sans)" font-size="10" font-weight="600" fill="var(--cyan)">Define</text>
          <text x="250" y="120" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--text-muted)">intent</text>
        </g>

        <!-- Node: Analyze (top-right) -->
        <g id="loop-analyze">
          <circle cx="363" cy="175" r="34" fill="var(--bg-card)" stroke="var(--teal)" stroke-width="1.5"/>
          <text x="363" y="171" text-anchor="middle" font-family="var(--sans)" font-size="10" font-weight="600" fill="var(--teal)">Analyze</text>
          <text x="363" y="185" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--text-muted)">prove</text>
        </g>

        <!-- Node: Compile (bottom-right) -->
        <g id="loop-compile">
          <circle cx="363" cy="305" r="34" fill="var(--bg-card)" stroke="var(--cyan)" stroke-width="1.5"/>
          <text x="363" y="301" text-anchor="middle" font-family="var(--sans)" font-size="10" font-weight="600" fill="var(--cyan)">Compile</text>
          <text x="363" y="315" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--text-muted)">to SQL</text>
        </g>

        <!-- Node: Apply (bottom) -->
        <g id="loop-apply">
          <circle cx="250" cy="370" r="34" fill="var(--bg-card)" stroke="var(--amber)" stroke-width="1.5"/>
          <text x="250" y="366" text-anchor="middle" font-family="var(--sans)" font-size="10" font-weight="600" fill="var(--amber)">Apply</text>
          <text x="250" y="380" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--text-muted)">enforce</text>
        </g>

        <!-- Node: Monitor (bottom-left) -->
        <g id="loop-monitor">
          <circle cx="137" cy="305" r="34" fill="var(--bg-card)" stroke="var(--red)" stroke-width="1.5"/>
          <text x="137" y="301" text-anchor="middle" font-family="var(--sans)" font-size="10" font-weight="600" fill="var(--red)">Monitor</text>
          <text x="137" y="315" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--text-muted)">drift</text>
        </g>

        <!-- Node: Reconcile (top-left) -->
        <g id="loop-reconcile">
          <circle cx="137" cy="175" r="34" fill="var(--bg-card)" stroke="var(--violet)" stroke-width="1.5"/>
          <text x="137" y="171" text-anchor="middle" font-family="var(--sans)" font-size="10" font-weight="600" fill="var(--violet)">Reconcile</text>
          <text x="137" y="185" text-anchor="middle" font-family="var(--mono)" font-size="8" fill="var(--text-muted)">fix drift</text>
        </g>

        <!-- Arrows between nodes -->
        <g stroke="var(--border-glow)" stroke-width="1.5" fill="none" marker-end="url(#arrow)">
          <line x1="280" y1="118" x2="333" y2="156"/>
          <line x1="363" y1="209" x2="363" y2="271"/>
          <line x1="333" y1="324" x2="280" y2="358"/>
          <line x1="220" y1="358" x2="167" y2="324"/>
          <line x1="137" y1="271" x2="137" y2="209"/>
          <line x1="167" y1="156" x2="220" y2="118"/>
        </g>

        <text x="250" y="445" text-anchor="middle" font-family="var(--sans)" font-size="12" fill="var(--text-muted)">Complete governance, not a one-time script.</text>
      </g>

    </svg>
  </div><!-- /viz-container -->

</div><!-- /scrolly -->

<div class="divider"></div>

<!-- ═══════════════════════ OUTRO ══════════════════════════ -->
<footer class="outro">
  <h2>Ready to make data governance <em style="font-style:italic;background:linear-gradient(135deg,var(--cyan),var(--teal));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">provable</em>?</h2>
  <p>The policy engine turns security intent into verifiable enforcement.</p>
</footer>

<!-- ═══════════════════════ JAVASCRIPT ═════════════════════ -->
<script>
(function () {
  'use strict';

  /* ── State ── */
  var currentStep = null;
  var groups = {};

  for (var i = 1; i <= 10; i++) {
    groups[i] = document.getElementById('step' + i);
  }

  /* ── Scroll progress bar ── */
  var progressBar = document.getElementById('progressBar');
  window.addEventListener('scroll', function () {
    var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
    var scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    var pct = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
    progressBar.style.width = pct + '%';
  }, { passive: true });

  /* ── Keyboard navigation (section-by-section, centered) ── */
  function navigateToStep(step) {
    var clamped = Math.max(1, Math.min(step, sections.length));
    var section = document.querySelector('.section[data-step="' + clamped + '"]');
    if (section) section.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }

  document.addEventListener('keydown', function(e) {
    var forward = e.key === 'ArrowDown' || e.key === 'PageDown'
               || (e.key === ' ' && !e.shiftKey);
    var backward = e.key === 'ArrowUp' || e.key === 'PageUp'
                || (e.key === ' ' && e.shiftKey);

    if (forward || backward) {
      e.preventDefault();
      var next = (currentStep || 1) + (forward ? 1 : -1);
      navigateToStep(next);
    }
  });

  /* ── Step indicator dots ── */
  var dots = document.querySelectorAll('.step-dot');
  dots.forEach(function (dot) {
    dot.addEventListener('click', function () {
      var target = dot.getAttribute('data-target');
      var section = document.querySelector('.section[data-step="' + target + '"]');
      if (section) section.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });
  });

  function updateDots(step) {
    dots.forEach(function (dot) {
      if (parseInt(dot.getAttribute('data-target'), 10) === step) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });
  }

  /* ── Loop animation for step 10 ── */
  var loopInterval = null;
  var loopNodeIds = [
    'loop-define', 'loop-analyze', 'loop-compile',
    'loop-apply', 'loop-monitor', 'loop-reconcile'
  ];
  var loopColors = ['var(--cyan)', 'var(--teal)', 'var(--cyan)', 'var(--amber)', 'var(--red)', 'var(--violet)'];
  var loopGlows = ['glow-cyan', 'glow-teal', 'glow-cyan', 'glow-amber', 'glow-red', 'glow-cyan'];

  function startLoopAnimation() {
    var idx = 0;
    loopInterval = setInterval(function () {
      loopNodeIds.forEach(function (id, i) {
        var el = document.getElementById(id);
        if (!el) return;
        var circle = el.querySelector('circle');
        if (!circle) return;
        if (i === idx) {
          circle.setAttribute('stroke-width', '2.5');
          circle.style.filter = 'url(#' + loopGlows[i] + ')';
        } else {
          circle.setAttribute('stroke-width', '1.5');
          circle.style.filter = 'none';
        }
      });
      idx = (idx + 1) % loopNodeIds.length;
    }, 700);
  }

  function stopLoopAnimation() {
    if (loopInterval) {
      clearInterval(loopInterval);
      loopInterval = null;
    }
    loopNodeIds.forEach(function (id) {
      var el = document.getElementById(id);
      if (!el) return;
      var circle = el.querySelector('circle');
      if (circle) {
        circle.setAttribute('stroke-width', '1.5');
        circle.style.filter = 'none';
      }
    });
  }

  /* ── Transition to a step ── */
  function updateVisualization(step) {
    step = parseInt(step, 10);
    if (step === currentStep) return;

    /* Hide all groups */
    for (var key in groups) {
      if (groups[key]) groups[key].classList.remove('visible');
    }

    /* Show current group */
    if (groups[step]) {
      groups[step].classList.add('visible');
    }

    /* Handle loop animation */
    if (step === 10) {
      startLoopAnimation();
    } else {
      stopLoopAnimation();
    }

    updateDots(step);
    currentStep = step;
  }

  /* ── Intersection Observer ── */
  var sections = document.querySelectorAll('.section[data-step]');

  var observer = new IntersectionObserver(function (entries) {
    entries.forEach(function (entry) {
      if (entry.isIntersecting) {
        /* Highlight active section */
        sections.forEach(function (s) { s.classList.remove('active'); });
        entry.target.classList.add('active');

        /* Update viz */
        updateVisualization(entry.target.dataset.step);
      }
    });
  }, {
    threshold: 0.15,
    rootMargin: '-33% 0px -33% 0px'
  });

  sections.forEach(function (s) { observer.observe(s); });

  /* ── Show step 1 initially ── */
  updateVisualization(1);
  if (sections[0]) sections[0].classList.add('active');
})();
</script>

</body>
</html>
